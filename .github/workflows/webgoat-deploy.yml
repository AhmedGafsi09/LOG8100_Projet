name: Deploy WebGoat
on:
  workflow_call:
  workflow_dispatch:

jobs:
  deploy-webgoat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          repository: 'AhmedGafsi09/LOG8100_Projet'
          path: 'LOG8100_Projet'

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_PRIVATE_KEY }}" > ~/.ssh/aks-node-1_key.pem
          chmod 600 ~/.ssh/aks-node-1_key.pem
          ssh-keyscan -H 20.63.16.243 >> ~/.ssh/known_hosts

      - name: Get Kubeconfig from VM
        run: |
          mkdir -p ~/.kube
          scp -i ~/.ssh/aks-node-1_key.pem azureuser@20.63.16.243:.kube/config ~/.kube/config
          chmod 600 ~/.kube/config
          # Ensure we're using the external IP
          sed -i 's/10.0.0.4/20.63.16.243/g' ~/.kube/config

      - name: Validate Cluster Connection
        run: |
          kubectl config view
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy WebGoat
        run: |
          # Create namespace if it doesn't exist
          kubectl create namespace webgoat --dry-run=client -o yaml | kubectl apply -f -

          # Create deployment
          cat << EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: webgoat
            namespace: webgoat
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: webgoat
            template:
              metadata:
                labels:
                  app: webgoat
              spec:
                containers:
                - name: webgoat
                  image: ${{ secrets.DOCKER_USERNAME }}/log8100_projet:latest
                  imagePullPolicy: Always
                  ports:
                  - containerPort: 8080
                  resources:
                    limits:
                      memory: "1Gi"
                      cpu: "500m"
                    requests:
                      memory: "512Mi"
                      cpu: "250m"
                  readinessProbe:
                    httpGet:
                      path: /WebGoat
                      port: 8080
                    initialDelaySeconds: 30
                    periodSeconds: 10
          EOF

          # Create service
          cat << EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: webgoat
            namespace: webgoat
          spec:
            type: NodePort
            selector:
              app: webgoat
            ports:
            - port: 8080
              targetPort: 8080
              nodePort: 30080
              name: http
          EOF

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to be ready..."
          kubectl rollout status deployment/webgoat -n webgoat --timeout=300s

      - name: Verify deployment
        run: |
          echo "Deployment Status:"
          kubectl get deployment -n webgoat
          
          echo "Pod Status:"
          kubectl get pods -n webgoat
          
          echo "Service Status:"
          kubectl get svc -n webgoat
          
          echo "Application will be available at:"
          echo "http://20.63.16.243:30080/WebGoat"
